# conda 包修改工具规则说明

有时我们想修改某个 conda 包的内容，例如

1. 向 conda 包添加我们自定义内容
2. 将 conda 包中的文件移动到包的另一个位置
3. 删除 conda 包中的有些文件或者目录

为此开发了 conda 包修改工具来满足上面的需求。

为了准确描述上面的需求，我们需要书写一个规则文件，conda 包修改工具根据该规则文件来执行具体的操作。

## 规则文件的具体说明

规则需要书写在一个 json 文件中，文件内容是一个 dict，dict 的键为需要修改的包的名称，值为需要执行的三类操作的一个或多个。

具体示例如下：

```json
{
  "conda": {
    "add": {
      "/xxx/conda_tool/dist/conda_tool-0.1.0-py3-none-any.whl": "bin/",
      "/xxx/conda_tool/.vscode/": "share/",
      "../../src/conda_tool/*": "bin/"
    },
    "mv": {
      "bin/conda": "bin/_conda",
      "etc/fish": "share/"
    },
    "delete": ["etc/fish", "xonsh"]
  }
}
```

下面具体介绍三类操作的具体写法。

### add 操作

add 操作的规则同样由键值对构成，其中键定义需要添加文件或者目录，值对应 conda 包中的路径。

键可以为绝对路径或相对路径，相对路径相对于本规则文件。
键也支持目录，如果键以 `/` 结尾，则对应的值必须也以 `/` 结尾，表示将键对应的目录拷贝到值对应的目录下。
键也支持模糊匹配，此时对应的值必须以 `/` 结尾；例如上面例子中的 `../../src/conda_tool/*` 代表将 conda_tool 目录下的所有文件目录拷贝到 conda 包的 `bin/` 目录下。

值必须为相对路径，相对于解压后的 conda 包路径。
值如果是目录，则必须以 `/` 结尾；

### mv 操作

mv 操作对应的路径都是相对 conda 包的路径，即操作的对象都是 conda 包中的内容。
匹配规则与上面的 add 操作类似，这里就不再具体展开说明。

### delete 操作

delete 操作后面对应的是需要删除包中的路径或目录。
匹配规则类似 gitignore 中的规则，具体实现使用了 pathspec 包的实现。
